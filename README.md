## логика обработки товара в заказе

**Обязательное перемещение** - то перемещение которое формируется для нужд заказов. При закрытии и получении не оказывают влияния на кол-во на складе. (тк уже учтены в заказах, тое находятся в них)

**Необязательное перемещение** - пермещение сформированное вручную, оказывают влияние на склад при получении и формировании, пополняют и списывают соотв.



**События:**

### Поступление заказа на N товара.

Проверяем количество на складе сопряженных с тем где осуществлен заказ.

Если кол-во(S - store) >= N то списываем(S-N) с этого склада и завершаем обработку.

Другой случай если S < N то списываем что есть и проверяем кол-во в необязательных перемещениях. 

При том теперь N = N - S (если значение положительное), тое это необходимый остаток.

Если товар обнаружен в необязательных закрытых (тое уже сформированных) перемещениях(T - transaction) на этот склад то переводим кол-во T - N из необязательных в обязательное перемещения(закрытые).

При том теперь N = N - R (если N >= R) или N = 0 тое это необходимый остаток.

Если N = 0 завершаем, если нет продложаем смотреть на другом складе.

Если товар(на удаленном складе) отсутствует присваиваем отрицательное кол-во на текущем складе (S-N).

Если товар присутствует на другом складе(R - remote) списываем его оттуда. 

Два случая: Если R >= N то теперь осаток на уделенном складе R - N и формирется обязательное перемещение на N товаров.

Второй случай если R < N, то списываем R товара и формируем обязательное перемещение на R товара. Так же записываем на текущем складе остаток 
S-N

### Изменение кол-ва в заказе на повышение (U - разница в кол-ве)

Выполняем все действия из пункта **Поступление заказа на N товара** при N = U

### Изменение кол-ва в заказе на понижение (D = S(old) - S(new), тое это разница в кол-ве )

Необязательные перемещения не учитываются.

Производим поиск обязятельных перемещений, возможны следующие случаи:

Перемещений нет - то пополняем текущий склад на D товаров.

**Есть открытые(обязательные) перемещения**
(O - open, сумма всех товаров этой позиции в открытых обязательных перемещениях) считаем
условие O >= D, если условие выполняется то удаляем D открытых перемещений и при этом пополняем склад-источник на D единиц. Заканчиваем обработку в этом случае. 
Если условие O >= D не выпоняется то удаляем O товаров в открытых перемещениях и при этом поплняем склад-источник на О единиц товара. Остается остаток D - O не решенных единиц. Присваиваем D = D - O и проверяем наличие закрытых(обязательных) перемещений, если их нет - пополняем текущий склад на D единиц. Заканчиваем обработку этого случая. Если перемещения есть то преходим к следующему пункту.

**Есть закрытые(обязательные) перемещения**
(С - closed, сумма всех товаров этой позиции в закрытых обязательных перемещениях) считаем
условие С >= D, если условие выполняется то  переводим кол-во D товаров из обязательных в необязательные (что-бы по поступлению они просто пополнили склад, тк теперь они не выполняют нужды заказа). Заканчиваем обработку в этом случае. 
Если условие С >= D не выпоняется то переводим C товаров в перемещениях из обязательных в необязательные(закрытые). 
Пополняем текущий склад на D - C товаров. На этом обработка завершена. 

